name: Deploy to server with Telegram notifications

on:
  push:
    branches: ["*"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: SSH - Prepare and Pull Code
      uses: appleboy/ssh-action@v1.0.0
      id: prepare
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 8542
        command_timeout: 20m
        script: |
          echo "== [1] –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ =="
          cd ~/Desktop/library || exit 1

          echo "== [2] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π =="
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚Üí –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞—é..."
            git reset --hard HEAD
            git clean -fd
          fi

          echo "== [3] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è =="
          git pull

    - name: SSH - Stop Previous Containers
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 8542
        command_timeout: 10m
        script: |
          echo "== [4] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã =="
          cd ~/Desktop/library || exit 1
          docker-compose down

    - name: SSH - Build and Start
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 8542
        command_timeout: 20m
        script: |
          echo "== [5] –°–æ–±–∏—Ä–∞—é –∏ –∑–∞–ø—É—Å–∫–∞—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã =="
          cd ~/Desktop/library || exit 1
          docker-compose build
          docker-compose up -d

          echo "== [6] –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ =="
          docker-compose logs --tail=100

    - name: Send Telegram notification (Success)
      if: success()
      uses: appleboy/telegram-action@v1.0.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –í–µ—Ç–∫–∞: ${{ github.ref }}
          –°–µ—Ä–≤–µ—Ä: ${{ secrets.SSH_HOST }}
          –ó–∞–ø—É—Å—Ç–∏–ª: ${{ github.actor }}

          üîó http://5.129.199.10:8777/docs

          –î–ª—è –ª–æ–≥–æ–≤: `docker-compose logs -f`

    - name: Send Telegram notification (Failure)
      if: failure()
      uses: appleboy/telegram-action@v1.0.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚ùå –î–µ–ø–ª–æ–π —É–ø–∞–ª!
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          –í–µ—Ç–∫–∞: ${{ github.ref }}
          –û—à–∏–±–∫–∞ –≤ —à–∞–≥–µ: ${{ steps.prepare.outcome }}
          –ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
